<!-- Experience Detail Container -->
<div *ngIf="experience" [ngClass]="{'modal-overlay': isVisible}" (click)="isVisible ? closeModal() : null">
  <div [ngClass]="{'modal-content': isVisible, 'container mt-4': !isVisible}" (click)="$event.stopPropagation()">

    <!-- Floating Close Button -->
    <button *ngIf="isVisible"
      type="button"
      class="floating-close-btn"
      (click)="closeModal()"
      title="Close"
      (mouseenter)="$event.stopPropagation()">
      <i class="fas fa-times"></i>
    </button>
    <div class="modal-header">
      <div class="d-flex align-items-center">
        <div class="company-logo me-3">
          <div class="company-letter" [style.background-color]="'#007bff'">
            {{ experience.company.charAt(0).toUpperCase() }}
          </div>
        </div>
        <div>
          <h3 class="modal-title mb-1">{{ experience.company }}</h3>
          <h5 class="mb-0">{{ experience.role }}</h5>
        </div>
      </div>
      <button type="button" class="btn-close" (click)="closeModal()"></button>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav nav-tabs mb-3">
      <button class="nav-link active">
        <i class="fas fa-info-circle me-1"></i>
        Details
      </button>
    </div>

    <div class="modal-body">
      <!-- Preparation Journey Section (if available) -->
      <div *ngIf="hasPreparationJourney()" class="info-section preparation-journey-highlight">
        <h6 class="section-title">ğŸš€ Interview Preparation Journey</h6>

        <!-- Quick Stats -->
        <div class="row g-3 mb-4" *ngIf="experience.preparationDuration || experience.practiceHours || experience.mocksGiven || experience.problemsSolved">
          <div class="col-md-3" *ngIf="experience.preparationDuration">
            <div class="prep-stat-card">
              <div class="prep-stat-value">{{ experience.preparationDuration }}</div>
              <div class="prep-stat-label">Preparation Duration</div>
            </div>
          </div>
          <div class="col-md-3" *ngIf="experience.practiceHours">
            <div class="prep-stat-card">
              <div class="prep-stat-value">{{ experience.practiceHours }}h/day</div>
              <div class="prep-stat-label">Daily Practice</div>
            </div>
          </div>
          <div class="col-md-3" *ngIf="experience.mocksGiven">
            <div class="prep-stat-card">
              <div class="prep-stat-value">{{ experience.mocksGiven }}</div>
              <div class="prep-stat-label">Mock Interviews</div>
            </div>
          </div>
          <div class="col-md-3" *ngIf="experience.problemsSolved">
            <div class="prep-stat-card">
              <div class="prep-stat-value">{{ experience.problemsSolved }}</div>
              <div class="prep-stat-label">Problems Solved</div>
            </div>
          </div>
        </div>

        <!-- Confidence & Approach -->
        <div class="row g-3 mb-3" *ngIf="experience.confidenceLevel || experience.preparationApproach">
          <div class="col-md-6" *ngIf="experience.confidenceLevel">
            <strong class="prep-subsection-title">ğŸ¯ Confidence Level:</strong>
            <div class="prep-content">{{ experience.confidenceLevel }}</div>
          </div>
          <div class="col-md-6" *ngIf="experience.preparationApproach">
            <strong class="prep-subsection-title">ğŸ“š Preparation Approach:</strong>
            <div class="prep-content">{{ experience.preparationApproach }}</div>
          </div>
        </div>

        <!-- Study Materials -->
        <div *ngIf="hasItems(experience.studyMaterials)" class="mb-3">
          <strong class="prep-subsection-title">ğŸ“š Study Materials Used:</strong>
          <div class="prep-tags-container">
            <span *ngFor="let material of experience.studyMaterials" class="badge bg-primary me-2 mb-1">
              {{ material }}
            </span>
          </div>
        </div>

        <!-- Key Topics -->
        <div *ngIf="hasItems(experience.keyTopics)" class="mb-3">
          <strong class="prep-subsection-title">ğŸ¯ Key Topics Focused:</strong>
          <div class="prep-tags-container">
            <span *ngFor="let topic of experience.keyTopics" class="badge bg-success me-2 mb-1">
              {{ topic }}
            </span>
          </div>
        </div>

        <!-- Preparation Tips -->
        <div *ngIf="experience.preparationTips" class="mb-3">
          <strong class="prep-subsection-title">ğŸ’¡ Preparation Tips:</strong>
          <div class="prep-content">{{ experience.preparationTips }}</div>
        </div>

        <!-- Challenges -->
        <div *ngIf="experience.challenges" class="mb-3">
          <strong class="prep-subsection-title">âš ï¸ Challenges Faced:</strong>
          <div class="prep-content">{{ experience.challenges }}</div>
        </div>

        <!-- Time Management -->
        <div *ngIf="experience.timeManagement" class="mb-3">
          <strong class="prep-subsection-title">â° Time Management Strategy:</strong>
          <div class="prep-content">{{ experience.timeManagement }}</div>
        </div>

        <!-- Most Helpful Resources -->
        <div *ngIf="experience.resourcesHelpful" class="mb-3">
          <strong class="prep-subsection-title">â­ Most Helpful Resources:</strong>
          <div class="prep-content">{{ experience.resourcesHelpful }}</div>
        </div>

        <!-- Would Change Approach -->
        <div *ngIf="experience.wouldChangeApproach" class="mb-3">
          <strong class="prep-subsection-title">ğŸ”„ What I Would Do Differently:</strong>
          <div class="prep-content">{{ experience.wouldChangeApproach }}</div>
        </div>

        <!-- Advice -->
        <div *ngIf="experience.advice" class="mb-3">
          <strong class="prep-subsection-title">ğŸ¯ Advice for Future Candidates:</strong>
          <div class="prep-content advice-content">{{ experience.advice }}</div>
        </div>
      </div>

      <!-- Basic Info Section -->
      <div class="info-section">
        <h6 class="section-title">ğŸ¢ Interview Information</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ’¼ Role:</span>
              <span class="info-value">{{ experience.role }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ“ Location:</span>
              <span class="info-value">{{ experience.location }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ï¿½ Date:</span>
              <span class="info-value">{{ formatDate(experience.createdAt) }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ï¿½ğŸ”¢ Rounds:</span>
              <span class="info-value">{{ experience.numberOfRounds }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ’» Coding Problems:</span>
              <span class="info-value">{{ experience.numberOfCodingProblems }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ“Š Difficulty:</span>
              <span [class]="getDifficultyBadgeClass(experience.difficulty)">
                {{ experience.difficulty }}
              </span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸŒ Mode:</span>
              <span class="badge bg-info">{{ experience.interviewMode }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ¯ Result:</span>
              <span [class]="getOfferBadgeClass(experience.gotOffer)">
                {{ experience.gotOffer ? 'âœ… Got Offer' : 'âŒ No Offer' }}
              </span>
            </div>
          </div>
          <div class="col-md-6" *ngIf="experience.referrerEmail">
            <div class="info-item">
              <span class="info-label">ğŸ‘¥ Referrer:</span>
              <span class="info-value">{{ experience.referrerEmail }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Candidate Info Section -->
      <div class="info-section">
        <h6 class="section-title">ğŸ‘¤ Candidate Information</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ“ Name:</span>
              <span class="info-value">{{ experience.name }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ“§ Email:</span>
              <span class="info-value">{{ experience.email }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ“± Phone:</span>
              <span class="info-value">{{ experience.phone }}</span>
            </div>
          </div>
          <div class="col-md-6" *ngIf="experience.linkedinProfile">
            <div class="info-item">
              <span class="info-label">ğŸ”— LinkedIn:</span>
              <a [href]="experience.linkedinProfile" target="_blank" class="info-link">
                View Profile
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Education Section -->
      <div class="info-section">
        <h6 class="section-title">ğŸ“ Education Background</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ« College:</span>
              <span class="info-value">{{ experience.college }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ“ Degree:</span>
              <span class="info-value">{{ experience.degree }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ”¬ Branch:</span>
              <span class="info-value">{{ experience.branch }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ“ˆ CGPA:</span>
              <span class="info-value">{{ experience.cgpa }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-item">
              <span class="info-label">ğŸ’¼ Experience:</span>
              <span class="info-value">{{ experience.experience }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Reference Questions Section -->
      <div *ngIf="experience.codingQuestions && experience.codingQuestions.length > 0" class="info-section">
        <h6 class="section-title">ğŸ“š Reference Questions</h6>
        <div class="coding-questions-grid">
          <div *ngFor="let question of experience.codingQuestions" class="question-detail-card">
            <div class="question-content">
              <p>{{ question.question }}</p>
              <span *ngIf="question.topic" class="topic-tag">{{ question.topic }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Tags Section -->
      <div *ngIf="experience.tags && experience.tags.length > 0" class="info-section">
        <h6 class="section-title">ğŸ·ï¸ Tags</h6>
        <div class="tags-container">
          <span *ngFor="let tag of experience.tags" class="badge bg-light text-dark me-2 mb-2">
            {{ tag }}
          </span>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="info-section">
        <h6 class="section-title">ğŸ“Š Quick Stats</h6>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">{{ experience.numberOfRounds }}</div>
            <div class="stat-label">Interview Rounds</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ experience.numberOfCodingProblems }}</div>
            <div class="stat-label">Coding Problems</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ experience.upvotes || 0 }}</div>
            <div class="stat-label">Upvotes</div>
          </div>
        </div>
      </div>

      </div>

      <!-- Reviews Section -->
      <div id="reviewsSection" class="info-section mb-4 px-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h6 class="section-title mb-0">
            <i class="fas fa-comments me-2"></i>
            Reviews and Comments
          </h6>
          <button class="btn btn-primary" (click)="toggleReviewForm()" *ngIf="currentUser">
            <i class="fas fa-plus me-2"></i>Add Review
          </button>
        </div>

        <!-- Add Review Form -->
        <div class="add-review-form card mb-4" *ngIf="currentUser && showReviewForm">
          <div class="card-body">
            <h5 class="mb-3">Write Your Review</h5>
            <form (ngSubmit)="submitReview()">
              <div *ngIf="submitError" class="alert alert-danger mb-3">
                {{ submitError }}
              </div>

              <div class="form-group mb-3">
                <label class="mb-2">Rating</label>
                <div class="rating-input">
                  <i *ngFor="let num of [1,2,3,4,5]"
                     class="fas fa-star rating-star"
                     [style.color]="hoverRating > 0 ? (num <= hoverRating ? '#ff6b35' : '#ddd') : (num <= newReview.rating ? '#ff6b35' : '#ddd')"
                     [style.font-size]="'24px'"
                     (click)="setRating(num)"
                     (mouseenter)="onStarHover(num)"
                     (mouseleave)="onStarLeave()"></i>
                </div>
                <div class="rating-display mt-2" *ngIf="newReview.rating > 0">
                  <small class="text-muted">You rated: {{ newReview.rating }}</small>
                </div>
              </div>

              <div class="form-group mb-3">
                <label for="reviewContent" class="mb-2">Your Review</label>
                <textarea
                  id="reviewContent"
                  class="form-control"
                  rows="4"
                  [(ngModel)]="newReview.content"
                  name="content"
                  placeholder="Share your thoughts about this interview experience..."
                  required></textarea>
              </div>
              <button type="submit" class="btn btn-primary"
                      [disabled]="!newReview.rating || !newReview.content">
                {{ isEditing ? 'Update Review' : 'Submit Review' }}
              </button>
            </form>
          </div>
        </div>

        <!-- Login to Review Message -->
        <div *ngIf="!currentUser" class="alert alert-info mb-4">
          <i class="fas fa-info-circle me-2"></i>
          Please <a href="/login" class="alert-link">login</a> to add your review.
        </div>

        <!-- Reviews List -->
        <div class="reviews-list ms-3">
          <div *ngFor="let review of reviews" class="review-card mb-3">
            <div class="review-header">
              <div class="review-user">
                <div class="user-avatar">
                  {{ review.userId.name.charAt(0).toUpperCase() }}
                </div>
                <div class="user-info">
                  <h6 class="mb-0">{{ review.userId.name }}</h6>
                  <small class="text-muted">
                    {{ review.createdAt | date:'MMM d, y' }}
                  </small>
                </div>
              </div>
              <div class="review-rating" *ngIf="review.rating > 0">
                <i *ngFor="let star of [1,2,3,4,5]" class="fas fa-star" [style.color]="star <= review.rating ? '#ff6b35' : '#ddd'"></i>
              </div>
            </div>
            <div class="review-content mt-2">
              {{ review.content }}
            </div>
            <div class="review-actions mt-2">
              <button class="btn btn-sm btn-light"
                      (click)="likeReview(review)"
                      [class.active]="isReviewLikedByCurrentUser(review)">
                <i class="fas fa-thumbs-up me-1"></i>
                {{ review.likes.length }}
              </button>
              <div class="action-buttons" *ngIf="isReviewOwner(review)">
                <button class="btn btn-sm btn-outline-primary me-2"
                        (click)="editReview(review)">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger"
                        (click)="review._id && deleteReview(review._id)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <div class="admin-action-buttons" *ngIf="isAdmin() && !isReviewOwner(review)">
                <button class="btn btn-sm btn-outline-danger"
                        (click)="review._id && adminDeleteReview(review._id)"
                        title="Admin Delete">
                  <i class="fas fa-trash"></i>
                  Admin Delete
                </button>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="reviews.length === 0" class="text-center py-4">
            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
            <h5>No reviews yet</h5>
            <p class="text-muted">Be the first to share your thoughts!</p>
          </div>
        </div>
      </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary btn-lg" (click)="closeModal()">
        <i class="fas fa-times me-2"></i>Close Experience
      </button>
    </div>
  </div>
</div>
